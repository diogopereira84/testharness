<?php

use Fedex\ShippingEstimator\Block\States;

/** @var States $block */
$states_block= $block->getLayout()->createBlock('Fedex\ShippingEstimator\Block\States');
$states = $states_block->getRegionsOfCountry('US');
?>

<div id="shipping-estimate-modal" class="shipping-modal">
    <div class="modal-body-content">
        <div class="title-modal text-center">
            <img class="img-auto" alt="Shipping calculator with shipping box icon" src="<?php echo $this->getViewFileUrl('images/shippingcost.png');?>">
            <div class="title-text mt-35">
                Shipping Estimates
            </div>
        </div>
        <div class="form-block estimate-form">
            <div class="error-template hide message-block message-error d-flex mb-30">
                <div class="icon d-flex d-no-shrink v-center">
                    <img alt="Error icon" class="img-auto" src="<?php echo $this->getViewFileUrl('images/error-white.svg');?>">
                </div>
                <div class="message-text">
                </div>
                <div class="ml-auto">
                    <button type="button" class="close-message" aria-label="Close error message">
                    </button>
                </div>
            </div>
            <div class="error-block">
            </div>
            <div class="form-group">
                <label for="shipping-region" class="form-label">SHIP TO REGION / STATE</label>
                <select id="shipping-region" class="form-control" data-error="Please enter a region or state.">
                    <option value="" disabled selected hidden>Select</option>
                    <?php foreach ($states as $state):?>
                    <option value="<?php echo $state['code'] ?>"><?php echo $state['name'] ?></option>
                    <?php endforeach; ?>
                </select>
            </div>
            <div class="form-group">
                <label for="shipping-zipcode" class="form-label">SHIP TO ZIP CODE</label>
                <div class="d-flex">
                    <input type="text" class="form-control" id="shipping-zipcode" placeholder="Enter Zip Code" maxlength="5" data-error="Please enter a valid zip code.">
                    <button type="button" disabled class="btn-update-location btn-outline d-no-shrink hide">
                        <span class="btn-text">UPDATE</span>
                        <img class="inline-loader valign-middle hide" src="<?php echo $this->getViewFileUrl('images/loader.svg');?>">
                    </button>
                </div>
                <div class="mt-10">
                    <a id="geolocate" href="#" role="button" class="link weight-bold">
                        <svg role="img" aria-labelledby="geolocate-title geolocate-desc" class="valign-top" width="16px" height="16px" viewBox="0 0 16 16" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                            <title id="geolocate-title">Location icon</title>
                            <desc id="geolocate-desc">Vector graphics to display the location icon</desc>
                            <g id="Breakpoints---Shipping-Modal" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
                                <g id="Brochure-default-1200" class="svg-disable" transform="translate(-375.000000, -764.000000)" fill="#0078B4">
                                    <g id="Group-8" transform="translate(237.000000, 204.000000)">
                                        <g id="Button/Text/Light-Background/Small/Default" transform="translate(133.790909, 552.000000)">
                                            <g id="Icon/Plus" transform="translate(0.000000, 4.000000)">
                                                <path d="M12,16 C14.209139,16 16,14.209139 16,12 C16,9.790861 14.209139,8 12,8 C9.790861,8 8,9.790861 8,12 C8,14.209139 9.790861,16 12,16 Z M12,4.5 C12.2761424,4.5 12.5,4.72385763 12.5,5 L12.5,7 L12.4976954,7.02445934 C14.8617545,7.25807614 16.7419239,9.13824546 16.9755407,11.5023046 L17,11.5 L17,11.5 L19,11.5 C19.2761424,11.5 19.5,11.7238576 19.5,12 C19.5,12.2761424 19.2761424,12.5 19,12.5 L17,12.5 L16.9755407,12.4976954 C16.7419239,14.8617545 14.8617545,16.7419239 12.4976954,16.9755407 C12.4997694,16.9823262 12.5,16.9911362 12.5,17 L12.5,19 C12.5,19.2761424 12.2761424,19.5 12,19.5 C11.7238576,19.5 11.5,19.2761424 11.5,19 L11.5,17 L11.5023046,16.9755407 C9.13824546,16.7419239 7.25807614,14.8617545 7.02445934,12.4976954 L7,12.5 L7,12.5 L5,12.5 C4.72385763,12.5 4.5,12.2761424 4.5,12 C4.5,11.7238576 4.72385763,11.5 5,11.5 L7,11.5 L7.02445934,11.5023046 C7.25807614,9.13824546 9.13824546,7.25807614 11.5023046,7.02445934 C11.5002181,7.01718642 11.5,7.00861868 11.5,7 L11.5,5 C11.5,4.72385763 11.7238576,4.5 12,4.5 Z" id="ðŸŽ¨-Color"></path>
                                            </g>
                                        </g>
                                    </g>
                                </g>
                            </g>
                        </svg>
                        USE MY LOCATION
                    </a>
                </div>
            </div>
            <div id="shipping-estimate" data-bind="scope: 'shipping-estimate'">
                <!-- ko template: getTemplate() --><!-- /ko -->
            </div>
        </div>
        <div class="bg-cl-aliceblue fs-16 info-wrapper text-center">
            <span class="fedex-bold">
                Please Note
            </span>
            <p class="mb-0 fs-16 info-text">
                The estimates provided are based on the current product configuration and only include the cost of shipping for this item in your cart.
            </p>
        </div>
    </div>
</div>

<script type="text/x-magento-init">
{
  "#shipping-estimate":{
    "Magento_Ui/js/core/app": {
      "components": {
        "shipping-estimate": {
          "component": "Magento_Catalog/js/shipping/shipping-estimate",
          "template": "Magento_Catalog/shipping-estimate"
        }
      }
    }
  }
}
</script>

<script type="text/javascript">
    require([
        'jquery',
        'ko',
        'pubsub',
        'Magento_Ui/js/modal/modal',
        'utils',
        'gmaps'
    ],function($, ko, pubsub, modal, utils) {
        var shippingModal = $('#shipping-estimate-modal').modal({
            buttons: [],
            modalClass: 'pointer-auto pdp-shipping-modal',
            trigger: '[data-trigger=trigger-shippingmodal]'
        });

        $('.pdp-shipping-modal').attr('aria-label','Shipping Estimates');
        shippingModal.on('modalclosed', function () {
            ko.postbox.publish("resetRate");
            $('.error-block').empty();
            $('#shipping-region').prop('selectedIndex',0);
            $('#shipping-zipcode').val('');
            $('.btn-update-location').addClass('hide');
        });
        $('#shipping-zipcode').on('input', function(e) {
            $(this).val($(this).val().replace(/[^0-9]/g, ''));
            $('.btn-update-location').prop('disabled', false );
        });
        $('#geolocate').on("click", function(args) {
            args.preventDefault();
            getUserLocation();
        });
        
        $('.btn-update-location').on("click", function() {
            $('#btn-get-estimate').trigger('click');
        });

        $(document).on('click', '.modal-popup.pointer-auto', function(e) {
            if(e.target.classList.contains('_show')) {
                    $(this).find('.action-close').trigger('click');
            }
        });

        $('#shipping-region').on('change', function() {
            $('.btn-update-location').prop('disabled', false );
        });
        async function getUserLocation() {
            var coordinates = await utils.getPosition();
            var locationData = await utils.reverseGeocode(coordinates);
            $('#shipping-region').val(locationData.state.short_name);
            $('#shipping-zipcode').val(locationData.zipcode.long_name);
        }
    });
</script>
